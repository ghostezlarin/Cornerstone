version: '3.8'

services:
  # PlantUML как веб-сервис
  plantuml-server:
    image: plantuml/plantuml-server:tomcat
    container_name: plantuml-server
    restart: unless-stopped
    ports:
      - "8080:8080"  # Экспортируем порт для отладки
    networks:
      - diagram-network

  # Flask приложение
  diagram-app:
    build: .
    container_name: diagram-app
    environment:
      - PLANTUML_SERVER_URL=http://plantuml-server:8080
      - DB_HOST=*
      - DB_PORT=*
      - DB_NAME=*
      - DB_USER=*
      - DB_PASSWORD=*
    volumes:
      - uml_data:/app/uml_files
    depends_on:
      - plantuml-server
    restart: unless-stopped
    networks:
      - diagram-network

  # Nginx как обратный прокси
  nginx:
    image: nginx:alpine
    container_name: diagram-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./logs:/var/log/nginx
    depends_on:
      - diagram-app
      - plantuml-server
    restart: unless-stopped
    networks:
      - diagram-network

volumes:
  uml_data:

networks:
  diagram-network:
    driver: bridge