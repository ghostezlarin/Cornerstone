version: '3.8'

services:
  # PlantUML как веб-сервис
  plantuml-server:
    image: plantuml/plantuml-server:tomcat
    container_name: plantuml-server
    restart: unless-stopped
    networks:
      - diagram-network

  # Flask приложение
  diagram-app:
    build: .
    container_name: diagram-app
    environment:
      - PLANTUML_JAR_PATH=/app/plantuml.jar
      - PLANTUML_SERVER_URL=http://plantuml-server:8080
      - DB_HOST=109.71.245.217
      - DB_PORT=5432
      - DB_NAME=Cornerstone
      - DB_USER=postgres
      - DB_PASSWORD=183492awedxzs
    volumes:
      - uml_data:/app/uml_files
    depends_on:
      - plantuml-server
    restart: unless-stopped
    networks:
      - diagram-network

  # Nginx как обратный прокси
  nginx:
    image: nginx:alpine
    container_name: diagram-nginx
    ports:
      - "80:80"
      - "443:443"  # для HTTPS в будущем
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./logs:/var/log/nginx
    depends_on:
      - diagram-app
      - plantuml-server
    restart: unless-stopped
    networks:
      - diagram-network

volumes:
  uml_data:

networks:
  diagram-network:
    driver: bridge